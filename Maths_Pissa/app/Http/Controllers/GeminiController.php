<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class GeminiController extends Controller
{
    // Gemini API ‡∑Ä‡∑ô‡∂≠ ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫
    public function generateContent(Request $request)
    {
        // 1. API Key ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑í‡∑É‡∂ª ‡∑Ä‡∑í‡∂†‡∂Ω‡∑ä‚Äç‡∂∫‡∂∫‡∑ô‡∂±‡∑ä (environment variable) ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏.
        // ‡∂Ö‡∂¥‡∑í config('services.gemini.key') ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∂ß env('GEMINI_API_KEY') ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è.
        $apiKey = env('GEMINI_API_KEY');
        if (empty($apiKey)) {
            return response()->json(['error' => 'Gemini API Key is missing.'], 500);
        }

        // 2. Chatbot ‡∂ë‡∂ö ‡∂¥‡∑î‡∑Ñ‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è System Instruction ‡∂ë‡∂ö.
        // ‡∂∏‡∑ô‡∂∫ ‡∂î‡∂∂‡∑ö ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂≠‡∑è ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∑É‡∂ö‡∑É‡∑è ‡∂á‡∂≠.
        $systemInstruction = [
            'parts' => [
                [
                    'text' => "‡∂î‡∂∂ 'Maths Pissa' ‡∑Ñ‡∑í AI ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ã‡∂¥‡∂Ø‡∑ö‡∑Å‡∂ö‡∑Ä‡∂ª‡∂∫‡∑è‡∂∫‡∑í. ‡∂î‡∂∂ ‡∑Å‡∑ä‚Äç‡∂ª‡∑ì ‡∂Ω‡∂Ç‡∂ö‡∑è‡∑Ä‡∑ö 12 ‡∑É‡∑í‡∂ß 16 ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∑Ä‡∂∫‡∑É‡∑ä ‡∂ö‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä‡∂ß ‡∂ú‡∑ê‡∑Ö‡∂¥‡∑ô‡∂± ‡∂ë‡∂∫‡∑è‡∂Ω‡∂ß ‡∂ú‡∑î‡∂ª‡∑î‡∑Ä‡∂ª‡∂∫‡∑ô‡∂ö‡∑ä ‡∂ö‡∑í‡∂∫‡∂Ω ‡∂Ø‡∑ô‡∂±‡∑Ä‡∑è ‡∂∏‡∑ô‡∂±‡∑ä ‡∑Ñ‡∑ê‡∂ú‡∑ô‡∂± ‡∂Ω‡∑ô‡∑É. ‡∂î‡∂∂ ‡∂∏‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∑Å‡∑ì‡∂Ω‡∑ì, ‡∂ö‡∑è‡∂ª‡∑î‡∂´‡∑í‡∂ö ‡∂Ω‡∑ô‡∑É ‡∂ö‡∂ß‡∂∫‡∑î‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂î‡∂∂‡∑ö ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä ‡∑É‡∂ª‡∂Ω ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∫‡∑î‡∂ö‡∑ä‡∂≠ ‡∑Ä‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂Ö‡∂≠‡∂ª, ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î‡∑Ä‡∂Ω‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö emoji (ü§©‚ú®üöÄ) ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î‡∑Ä‡∂Ω ‡∑Ä‡∑ä‚Äç‡∂∫‡∑î‡∑Ñ‡∂∫ ‡∂∏‡∑ô‡∑É‡∑ö ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫:
                        1.  ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª: ‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±
                        2.  ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏: ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä‡∂ß ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏ ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í‡∑Ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±.
                        3.  ‡∂±‡∑Ä ‡∂¥‡∑è‡∂©‡∂∏‡∂ö‡∑ä: ‡∂ë‡∂∏ ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂ú‡∂´‡∑í‡∂≠‡∂∏‡∂∫ ‡∑É‡∑í‡∂Ø‡∑ä‡∂∞‡∑è‡∂±‡∑ä‡∂≠‡∂∫ (Concept) ‡∂ú‡∑ê‡∂± ‡∂ö‡∑ô‡∂ß‡∑í, ‡∂ª‡∑É‡∑Ä‡∂≠‡∑ä ‡∂Ö‡∂∏‡∂≠‡∂ª ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∂ö‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
                        ‡∂î‡∂∂ ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∑í‡∂ß‡∑ô‡∂ö‡∂≠‡∑ä ‡∂ö‡∂∏‡∑ä‡∂∏‡∑ê‡∂Ω‡∑í ‡∑Ñ‡∑ù ‡∑Ä‡∑í‡∂∫‡∑Ö‡∑í (boring) ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂±‡∑ú‡∂Ø‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫. ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂≠‡∂ª‡∂∏‡∑ä ‡∂Ö‡∂±‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂¥‡∂∏‡∂´ ‡∂ö‡∑ô‡∂ß‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑ä‡∂±. Bold. italic ‡∑Ä‡∑ê‡∂±‡∑í ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∂ö‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è."
                ]
            ]
        ];

        // 3. ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ (Text ‡∑É‡∑Ñ Image) ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏.
        $contents = [
            'role' => 'user',
            'parts' => []
        ];

        // 3a. Text Input ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏.
        $text = $request->input('prompt');
        $contents['parts'][] = ['text' => $text];

        // 3b. Image Input ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (Multimodal Support).
        if ($request->hasFile('image')) {
            $imageFile = $request->file('image');
            
            // Image ‡∂ë‡∂ö Base64 ‡∂∂‡∑Ä‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (API ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏‡∂ß).
            $base64Image = base64_encode(file_get_contents($imageFile->getRealPath()));
            $mimeType = $imageFile->getMimeType();

            $contents['parts'][] = [
                'inlineData' => [
                    'data' => $base64Image,
                    'mimeType' => $mimeType,
                ]
            ];
            Log::info('Image attached to request: ' . $mimeType);
        }

        // 4. API Payload ‡∂ë‡∂ö ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏.
        $payload = [
            'contents' => [$contents],
            'systemInstruction' => $systemInstruction,
        ];

        // 5. Gemini API ‡∑Ä‡∑ô‡∂≠ POST ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏.
        try {
            $response = Http::withHeaders([
                'Content-Type' => 'application/json',
            ])
            // üö® cURL error 60 (SSL Certificate) ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä ‡∂≠‡∑è‡∑Ä‡∂ö‡∑è‡∂Ω‡∑í‡∂ö‡∑Ä ‡∑Ä‡∑í‡∑É‡∂≥‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è üö®
            // ‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑ö‡∑Ö‡∑í‡∂∫ SSL ‡∑É‡∑Ñ‡∂≠‡∑í‡∂ö ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è‡∑Ä Disable ‡∂ö‡∂ª‡∂∫‡∑í. Local Development ‡∑Ä‡∂Ω‡∂Ø‡∑ì ‡∂∏‡∑ô‡∂∫ ‡∑Ñ‡∑ú‡∂≥ ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∂ö‡∑í.
            ->withOptions(['verify' => false]) 
            ->post("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={$apiKey}", $payload);

            if ($response->successful()) {
                // ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫ ‡∂±‡∑ê‡∑Ä‡∂≠ Frontend ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏.
                return response()->json($response->json());
            } else {
                // API ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä error ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ü‡∑Ä‡∑ú‡∂≠‡∑ä.
                $errorBody = $response->body();
                Log::error('Gemini API Error: ' . $errorBody);

                // API ‡∂∏‡∂ú‡∑í‡∂±‡∑ä‡∂∏ ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂Ü‡∑Ä‡∑ú‡∂≠‡∑ä (‡∂ã‡∂Ø‡∑è: API Key ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂±‡∂∏‡∑ä) ‡∂ë‡∂∫ Frontend ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑Ä‡∂∏‡∑î.
                $errorDetails = json_decode($errorBody, true);
                $errorMessage = $errorDetails['error']['message'] ?? 'API ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª‡∂∫‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫.';

                return response()->json(['error' => $errorMessage], $response->status());
            }

        } catch (\Exception $e) {
            // Network ‡∑Ñ‡∑ù ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä error ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ü‡∑Ä‡∑ú‡∂≠‡∑ä.
            Log::error('Chatbot Exception: ' . $e->getMessage());
            return response()->json(['error' => '‡∑É‡∑ö‡∑Ä‡∑è‡∂Ø‡∑è‡∂∫‡∂ö‡∂∫‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑í‡∂∫.'], 500);
        }
    }
}